name: Guardioes do Codigo (CI)

on:
  push:
    branches: [ "main", "master", "feature/*", "ci/*", "refactor/*" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  testes-automatizados:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Baixando o repositÃ³rio
      uses: actions/checkout@v4

    - name: ðŸ Configurando Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: ðŸ“¦ Instalando dependÃªncias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest pandas openpyxl lxml

    - name: ðŸ“ Criando estrutura de pastas
      run: |
        mkdir -p output
        mkdir -p output-dashboard
        mkdir -p raw_data_local
        mkdir -p test_data
        mkdir -p configs

    - name: âš™ï¸ Gerando configuraÃ§Ã£o temporÃ¡ria
      run: |
        echo "ANO_DO_RELATORIO = 2025" > configs/settings_local.py
        echo "MES_DO_RELATORIO = 11" >> configs/settings_local.py
        echo "MODO_EXECUCAO = 'local'" >> configs/settings_local.py
        echo "CAMINHOS = {'local': {'input': 'raw_data_local', 'output': 'output'}}" >> configs/settings_local.py
        echo "NOME_ARQUIVO_CADASTRO = 'base_cadastral.csv'" >> configs/settings_local.py

    - name: ðŸŽ­ Preparando dados Mock
      run: |
        cp tests/fixtures/mock_presenca.xml raw_data_local/Ponto_2025-11.xml
        cp tests/fixtures/mock_cadastro.csv raw_data_local/base_cadastral.csv
        cp tests/fixtures/mock_cadastro.csv test_data/cadastro.csv
        cp tests/fixtures/mock_cadastro.csv test_data/io_alunos.csv
        touch test_data/feriados.csv

    - name: ðŸ§ª Rodando os GuardiÃµes (Pytest)
      run: |
        pytest tests/